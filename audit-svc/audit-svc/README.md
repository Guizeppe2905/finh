# Сборщик событий аудита

Игрушечный сервис сбора событий аудита.

Предоставляет два эндпоинта:

* `POST /api/event`

Принимает список событий аудита в теле запроса в формате JSON:

```json
[
  {
    "event_ts": "2023-12-05T12:55:52.805022+00:00", // Дата и время события в формате ISO 8601
    "application_name": "cauliflower", // Имя приложения, в котором произошло событие
    "event_kind": "UserCreated", // Короткий тип события (длина <126 байт)
    "payload": { // Произвольное содержимое события (любое JSON значение)
      "username": "user_NHVyXzBj"
    }
  }
]
```

Ответы:

* `201` -- успех;
* `422` -- некорректный формат тела запроса;

* `GET /api/event`

Возвращает список событий аудита в порядке старшинства (сначала самые новые).

Принимает два *query* параметра:

* `page_token` -- токен для получения конкретной страницы, получается при обычном запросе;
* `page_size` -- число событий в ответе;

Возращает события в JSON формате:

```json
{
  "next_page": 9041, // токен для получения следующей страницы
  "page_size": 1, // запрошенное число событий
  "data": [ // список событий
    {
      "event_ts": "2023-12-05T12:55:52.805022Z",
      "application_name": "cauliflower",
      "event_kind": "UserCreated",
      "payload": {
        "username": "user_NHVyXzBj"
      }
    }
  ]
}
```

Ответы:

* `200` -- успех;
* `422` -- некорректный формат запроса;

> Оба эти эндпоинта с шансом 10% вернут 500 вместо нормального ответа, это сделано для того, чтобы при построении визуализаций по метрикам сервиса в них были ошибки.

## Внутренние эндпоинты

* `GET /health` -- возвращает `200`;
* `GET /metrics` -- возвращает метрики в формате Prometheus;
* `POST /reload` -- перечитывает конфигурационный файл;

## Запуск

Сервис предоставляет три точки входа:

* `server` -- запустить сам сервис;
* `migrate` -- применить миграции БД;
* `generate` -- сгенерировать тестовые данные;

Эти скрипты добавляются в PATH виртуального окружения Python после установки при помощи `poetry install` или `pip install`. Параметры самих скриптов смотрите в их справке (запуск любого скрипта с параметром `-h` выведет на экран его справку).
